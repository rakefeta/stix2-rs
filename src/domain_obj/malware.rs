use serde::{Serialize, Deserialize};
use serde_with::skip_serializing_none;
// use serde_json::Result;
use chrono::NaiveDateTime;

use crate::
{
    types::{Identifier, List, Boolean, KillChainPhase},
    open_vocab::{MalwareTypeOv, ProcessorArchitectureOv, ImplementationLanguageOv,
        MalwareCapabilitiesOv},
    opt_com_props::OptComProps, 
    serialization_functions::{
        serialize_ndt, deserialize_ndt, serialize_ondt, deserialize_ondt
    }
};


// TODO: Optional Common Properties - not yet included
#[skip_serializing_none]
#[derive(Serialize, Deserialize, Debug)]
pub struct Malware {
    #[serde(alias = "type", rename="type")] // type is a rust keyword
    pub _type: String,
    pub spec_version: String,
    pub id: String,
    #[serde(serialize_with = "serialize_ndt", deserialize_with = "deserialize_ndt")]
    pub created: NaiveDateTime,
    #[serde(serialize_with = "serialize_ndt", deserialize_with = "deserialize_ndt")]
    pub modified: NaiveDateTime,
    pub name: Option<String>,
    pub description: Option<String>,
    pub malware_types: Option<List<MalwareTypeOv>>,
    pub is_family: Boolean,
    pub aliases: Option<List<String>>,
    pub kill_chain_phases: Option<List<KillChainPhase>>,
    #[serde(default, serialize_with = "serialize_ondt", deserialize_with = "deserialize_ondt")]
    pub first_seen : Option<NaiveDateTime>,
    #[serde(default, serialize_with = "serialize_ondt", deserialize_with = "deserialize_ondt")]
    pub last_seen : Option<NaiveDateTime>,
    pub operating_system_refs: Option<List<Identifier>>,
    pub architecture_execution_envs: Option<List<ProcessorArchitectureOv>>,
    pub implementation_language: Option<List<ImplementationLanguageOv>>,
    pub capabilities: Option<List<MalwareCapabilitiesOv>>,
    pub sample_refs: Option<List<Identifier>>,
    #[serde(flatten)]
    pub opt_com_props: Option<OptComProps>
}




#[cfg(test)]
mod tests {
    use super::*;
    #[test]
    fn malware_deserialization() {

        let json_str: &str = r#"
             {
                 "type": "malware",
                 "spec_version": "2.1",
                 "id": "malware--12345678-1234-1234-1234-123456789012",
                 "created": "2024-07-29T12:34:56.123Z",
                 "modified": "2024-07-29T12:34:56.123Z",
                 "name": "RansomwareXYZ",
                 "description": "RansomwareXYZ is a type of ransomware that encrypts files on the infected system and demands a ransom for the decryption key.",
                 "malware_types": ["ransomware"],
                 "is_family": false,
                 "aliases": ["RansomXYZ"],
                 "kill_chain_phases": [
                     {
                         "kill_chain_name": "mitre-attack",
                         "phase_name": "initial-access"
                     },
                     {
                         "kill_chain_name": "mitre-attack",
                         "phase_name": "execution"
                     }
                 ],
                 "first_seen": "2024-06-01T12:34:56.123Z",
                 "last_seen": "2024-07-29T12:34:56.123Z",
                 "labels": ["ransomware", "malicious"],
                 "capabilities": ["anti-disassembly", "captures-input-peripherals"],
                 "operating_system_refs": ["windows--12345678-1234-1234-1234-123456789012"],
                 "architecture_execution_envs": ["x86", "x86-64"],
                 "implementation_languages": ["C++", "Python"],
                 "external_references": [
                     {
                         "source_name": "MITRE ATT&CK",
                         "description": "RansomwareXYZ details in MITRE ATT&CK.",
                         "url": "https://attack.mitre.org/software/S1234/",
                         "external_id": "S1234"
                     },
                     {
                         "source_name": "Cyber Threat Intel",
                         "description": "Comprehensive analysis of RansomwareXYZ.",
                         "url": "https://example.com/cyber-threat-intel/ransomwarexyz",
                         "external_id": "CTI-789012"
                     }
                 ],
                 "object_marking_refs": [
                     "marking-definition--abcdef12-1234-5678-abcd-1234567890ab"
                 ],
                 "granular_markings": [
                     {
                         "marking_ref": "marking-definition--abcdef12-1234-5678-abcd-1234567890ab",
                         "selectors": ["description", "external_references[0].url"]
                     }
                 ],
                 "created_by_ref": "identity--abcd1234-abcd-1234-abcd-1234abcd5678",
                 "extensions": {
                     "extension-definition--abcd1234-abcd-1234-abcd-1234abcd5678": {
                         "extension_type": "new-sdo",
                         "name": "Extended Malware",
                         "description": "Extension for capturing additional information specific to the malware.",
                         "data": {
                             "related_indicators": [
                                 "indicator--abcd1234-abcd-1234-abcd-1234abcd5678"
                             ],
                             "detection_methods": [
                                 "Heuristic analysis",
                                 "Signature-based detection"
                             ],
                             "cve_ids": [
                                 "CVE-2023-1234",
                                 "CVE-2023-5678"
                             ],
                             "mitigations": [
                                 "Regular backups",
                                 "User training"
                             ]
                         }
                     }
                 }
             }
        "#;

        let _parsed_json: Malware = serde_json::from_str(&json_str).unwrap();
    }
}
